graph TD
    subgraph "Layer 1: Presentation Layer"
        A1[HTTP Endpoints<br/>REST API]
        A2[Middleware Stack<br/>Auth, Logging, Rate Limit]
        A3[Request/Response DTOs<br/>JSON Serialization]
    end

    subgraph "Layer 2: Application Layer"
        B1[Product Handler<br/>- CreateProduct<br/>- GetProduct<br/>- ListProducts<br/>- UpdateProduct]
        B2[Stock Handler<br/>- CreateStock<br/>- UpdateStock<br/>- GetAvailability]
        B3[Reservation Handler<br/>- CreateReservation<br/>- ConfirmReservation<br/>- CancelReservation]
        B4[Health Handler<br/>- CheckHealth<br/>- DBStatus]
    end

    subgraph "Layer 3: Domain/Business Layer"
        C1[Product Service<br/>Business Rules]
        C2[Stock Service<br/>Optimistic Locking<br/>Available Calculation]
        C3[Reservation Service<br/>TTL Management<br/>Status Transitions]
        C4[Sync Service<br/>Event Reconciliation]
    end

    subgraph "Layer 4: Infrastructure Layer"
        D1[Event Publishing<br/>EventPublisher Interface]
        
        subgraph "Publisher Implementations"
            D1A[Redis Publisher]
            D1B[Kafka Publisher ðŸ”œ]
            D1C[Mock Publisher]
            D1D[NoOp Publisher]
        end
        
        D2[Background Workers<br/>- Expiration Worker<br/>- Sync Worker]
    end

    subgraph "Layer 5: Data Access Layer"
        E1[Product Repository<br/>CRUD + Pagination]
        E2[Stock Repository<br/>Optimistic Locking<br/>Version Control]
        E3[Reservation Repository<br/>Status Queries<br/>TTL Queries]
        E4[Event Repository<br/>Event Sourcing<br/>Audit Trail]
    end

    subgraph "Layer 6: Database Layer"
        F1[(SQLite Database)]
        
        subgraph "Tables"
            F1A[products<br/>id, sku, name, price]
            F1B[stock<br/>id, product_id, store_id<br/>quantity, reserved, version]
            F1C[reservations<br/>id, product_id, customer_id<br/>quantity, status, expires_at]
            F1D[events<br/>id, event_type, aggregate_id<br/>payload, timestamp]
        end
    end

    subgraph "Layer 7: External Systems"
        G1[Redis Streams<br/>inventory-events<br/>maxlen ~100000]
        G2[Kafka ðŸ”œ<br/>inventory-topic]
        G3[Configuration<br/>.env file<br/>Environment Variables]
    end

    %% Layer 1 connections
    A1 --> A2
    A2 --> A3
    A3 --> B1
    A3 --> B2
    A3 --> B3
    A3 --> B4

    %% Layer 2 to Layer 3
    B1 --> C1
    B2 --> C2
    B3 --> C3
    B4 --> C1
    B4 --> C2

    %% Layer 3 to Layer 4
    C1 --> D1
    C2 --> D1
    C3 --> D1
    C4 --> D1
    D1 -.-> D1A
    D1 -.-> D1B
    D1 -.-> D1C
    D1 -.-> D1D

    %% Layer 3 to Layer 5
    C1 --> E1
    C2 --> E2
    C2 --> E3
    C3 --> E3
    C3 --> E2
    C1 --> E4
    C2 --> E4
    C3 --> E4
    C4 --> E4

    %% Layer 4 Workers to Layer 5
    D2 --> E3
    D2 --> E2
    D2 --> D1

    %% Layer 5 to Layer 6
    E1 --> F1
    E2 --> F1
    E3 --> F1
    E4 --> F1

    %% Layer 6 Tables
    F1 --> F1A
    F1 --> F1B
    F1 --> F1C
    F1 --> F1D

    %% Layer 4 to Layer 7
    D1A --> G1
    D1B -.-> G2
    
    %% Configuration
    G3 --> A2
    G3 --> D1

    %% Styling
    classDef presentation fill:#E8F5E9,stroke:#4CAF50,stroke-width:3px
    classDef application fill:#E3F2FD,stroke:#2196F3,stroke-width:3px
    classDef domain fill:#FFF9C4,stroke:#FBC02D,stroke-width:3px
    classDef infrastructure fill:#FCE4EC,stroke:#E91E63,stroke-width:3px
    classDef dataaccess fill:#F3E5F5,stroke:#9C27B0,stroke-width:3px
    classDef database fill:#E0F2F1,stroke:#009688,stroke-width:3px
    classDef external fill:#FFE0B2,stroke:#FF9800,stroke-width:3px

    class A1,A2,A3 presentation
    class B1,B2,B3,B4 application
    class C1,C2,C3,C4 domain
    class D1,D1A,D1B,D1C,D1D,D2 infrastructure
    class E1,E2,E3,E4 dataaccess
    class F1,F1A,F1B,F1C,F1D database
    class G1,G2,G3 external

    %% Notes
    note1[Dependency Rule:<br/>Inner layers don't depend on outer layers]
    note2[Event Publisher follows<br/>Dependency Inversion Principle]
    note3[Optimistic Locking in Stock Repository<br/>prevents race conditions]
